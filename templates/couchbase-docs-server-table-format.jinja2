{% macro generate_issue_table(issues, title, components, suffix) %}
{% set filtered_issues = issues | filter_by_component(components) %}

{% if filtered_issues | length > 0 %}
=== {{ title }}

[#table-known-issues-{{ user_settings.fields.release_number | replace_dots('') }}-{{ suffix }}, cols="10,40,40"]
|===
|Issue | Description | Resolution

{% for issue in filtered_issues %}
| {{ url_with_jira(user_settings.release_set.url, issue.key) }}

{% if not issue.fields['customfield_11402']  %}
a| {{ issue.fields.ai_summary or '{empty}' }}

{% if issue.fields.ai_service is defined %}
// Generated by [{{ issue.fields.ai_service['name']}}:{{ issue.fields.ai_service['model'] }}]
{% endif %}

{% else %}
a| {{ issue.raw['fields']['customfield_11402'] | replace("|", "\|") | replace("{{", "`")  | replace("}}", "`")}}

{% endif %}
| Issue resolved

{% endfor %}
|===
{% endif %}
{% endmacro %}

{% macro generate_uncategorized_issue_table(issues, title, components, suffix) %}
{% set filtered_issues = issues | filter_out_by_component(components) %}

{% if filtered_issues | length > 0 %}
=== {{ title }}

[#table-known-issues-{{ user_settings.fields.release_text | replace_dots('') }}-{{ suffix }}]
|===
|Issue | Description | Resolution

{% for issue in filtered_issues %}

| {{ url_with_jira(user_settings.release_set.url, issue.key) }}

{% if issue.fields['customfield_11402'] is not none and issue.fields['customfield_11402'] | length > 0 %}
a| {{ issue.raw['fields']['customfield_11402'] | replace("|", "\|") | replace("{{", "`")  | replace("}}", "`")}}
{% else %}
a| {{ issue.fields.ai_summary or '{empty}' }}

{% if issue.fields.ai_service is defined %}
// Generated by [{{ issue.fields.ai_service['name']}}:{{ issue.fields.ai_service['model'] }}]
{% endif %}

{% endif %}

| Issue resolved
{% endfor %}
|===
{% endif %}
{% endmacro %}

[#release-{{ user_settings.fields.release_number | replace_dots('') }}]
== Release {{ user_settings.fields.release_number }} ({{ user_settings.fields.release_date }})

Couchbase Server {{ user_settings.fields.release_number }} was released in {{ user_settings.fields.release_date }}.
This maintenance release contains fixes to issues.

== Fixed Issues

{{ generate_issue_table(issues, 'Installer', ['installer'], 'installation') }}
{{ generate_issue_table(issues, 'Cluster Manager', ['ns_server'], 'cluster-manager') }}
{{ generate_issue_table(issues, 'Storage', ['storage-engine','couchbase-bucket'], 'storage') }}
{{ generate_issue_table(issues, 'Data Service', ['memcached'], 'data-service') }}
{{ generate_issue_table(issues, 'Views', ['view-engine', 'UI'], 'views') }}
{{ generate_issue_table(issues, 'XDCR', ['XDCR'], 'xdcr') }}
{{ generate_issue_table(issues, 'Query Service', ['query'], 'query-service') }}
{{ generate_issue_table(issues, 'Eventing Service', ['eventing'], 'eventing-service') }}
{{ generate_issue_table(issues, 'Analytics Service', ['analytics'], 'analytics-service') }}
{{ generate_issue_table(issues, 'Index Service', ['secondary-index'], 'index-service') }}
{{ generate_issue_table(issues, 'Search Service', ['fts'], 'search-service') }}
{{ generate_issue_table(issues, 'Tools', ['tools', 'build'], 'tools') }}
{{ generate_uncategorized_issue_table(issues, 'Uncategorized',['installer', 'ns_server',
'storage-engine', 'couchbase-bucket', 'memcached', 'XDCR', 'query', 'eventing',
'tools','analytics', 'secondary-index', 'UI', 'build',
'fts', 'tools' ],'uncategorized') }}
